spec is "1.0"

record "User":
  fields:
    id is number must be present
    name is text must be present
    role is text must be present

record "Task":
  fields:
    id is number must be present
    title is text must be present
    assignee is text must be present
    status is text must be present
    priority is text must be present

record "Status":
  field "message" is text must be present

flow "seed_users":
  set state.user with:
    id is 1
    name is "Ava Admin"
    role is "admin"
  create "User" with state.user as user
  set state.user with:
    id is 2
    name is "Ben Member"
    role is "member"
  create "User" with state.user as user
  set state.user with:
    id is 3
    name is "Cora Member"
    role is "member"
  create "User" with state.user as user
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "seeded users"

flow "seed_tasks":
  set state.task with:
    id is 101
    title is "Draft roadmap"
    assignee is "Ava Admin"
    status is "Todo"
    priority is "High"
  create "Task" with state.task as task
  set state.task with:
    id is 102
    title is "Review onboarding"
    assignee is "Ben Member"
    status is "Doing"
    priority is "Med"
  create "Task" with state.task as task
  set state.task with:
    id is 103
    title is "QA checklist"
    assignee is "Cora Member"
    status is "Todo"
    priority is "Low"
  create "Task" with state.task as task
  set state.task with:
    id is 104
    title is "Release notes"
    assignee is "Ava Admin"
    status is "Done"
    priority is "Med"
  create "Task" with state.task as task
  set state.task with:
    id is 105
    title is "Bug triage"
    assignee is "Ben Member"
    status is "Doing"
    priority is "High"
  create "Task" with state.task as task
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "seeded tasks"

flow "reset_state":
  set state.task with:
    id is null
    title is null
    assignee is null
    status is null
    priority is null
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "reset"

flow "create_task":
  set state.task with:
    id is input.values.id
    title is input.values.title
    assignee is input.values.assignee
    status is input.values.status
    priority is input.values.priority
  create "Task" with state.task as task
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "created"

flow "move_status":
  find "Task" where id is input.values.id
  let total is list length of task_results
  if total is less than 1:
    set state.error is "Task not found."
    set state.status.message is state.error
    create "Status" with state.status as status
    return "missing"
  let idx is total - 1
  let current is list get task_results at idx
  set state.task with:
    id is current.id
    title is current.title
    assignee is current.assignee
    status is input.values.status
    priority is current.priority
  create "Task" with state.task as task
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return state.task.status

flow "mark_done": requires identity.role is "admin"
  find "Task" where id is input.values.id
  let total is list length of task_results
  if total is less than 1:
    set state.error is "Task not found."
    set state.status.message is state.error
    create "Status" with state.status as status
    return "missing"
  let idx is total - 1
  let current is list get task_results at idx
  set state.task with:
    id is current.id
    title is current.title
    assignee is current.assignee
    status is "Done"
    priority is current.priority
  create "Task" with state.task as task
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "done"

page "home":
  title is "Task Manager"
  section "Quick actions":
    row:
      column:
        button "Seed Users":
          calls flow "seed_users"
      column:
        button "Seed Tasks":
          calls flow "seed_tasks"
      column:
        button "Reset":
          calls flow "reset_state"
  section "Create task":
    card "New task":
      form is "Task"
      button "Create task":
        calls flow "create_task"
  section "Tasks":
    card "Task board":
      table is "Task"
  section "Admin actions":
    card "Mark Done":
      table is "Task"
      button "Mark Done (admin)":
        calls flow "mark_done"
    card "Move status":
      text is "Use the same task id to move status."
      button "Move status":
        calls flow "move_status"
  card "Status":
    table is "Status"
