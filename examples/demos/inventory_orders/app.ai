spec is "1.0"

record "Product":
  field "sku" is text must be present
  field "name" is text must be present
  field "price" is number must be greater than 0

record "Inventory":
  field "sku" is text must be present
  field "quantity" is number must be at least 0

record "Order":
  field "id" is number must be present
  field "sku" is text must be present
  field "quantity" is number must be greater than 0
  field "status" is text must be present

record "Alert":
  field "sku" is text must be present
  field "message" is text must be present

record "Status":
  field "message" is text must be present

flow "seed_products":
  set state.product.sku is "SKU-100"
  set state.product.name is "Widget Alpha"
  set state.product.price is 25
  create "Product" with state.product as product
  set state.inventory.sku is "SKU-100"
  set state.inventory.quantity is 10
  create "Inventory" with state.inventory as inventory
  set state.product.sku is "SKU-200"
  set state.product.name is "Widget Bravo"
  set state.product.price is 45
  create "Product" with state.product as product
  set state.inventory.sku is "SKU-200"
  set state.inventory.quantity is 5
  create "Inventory" with state.inventory as inventory
  set state.product.sku is "SKU-300"
  set state.product.name is "Widget Charlie"
  set state.product.price is 30
  create "Product" with state.product as product
  set state.inventory.sku is "SKU-300"
  set state.inventory.quantity is 2
  create "Inventory" with state.inventory as inventory
  set state.product.sku is "SKU-400"
  set state.product.name is "Widget Delta"
  set state.product.price is 15
  create "Product" with state.product as product
  set state.inventory.sku is "SKU-400"
  set state.inventory.quantity is 8
  create "Inventory" with state.inventory as inventory
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "seeded"

flow "reset_state":
  set state.order.id is null
  set state.order.sku is null
  set state.order.quantity is null
  set state.order.status is null
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "reset"

flow "place_order":
  find "Inventory" where sku is input.values.sku
  let count is list length of inventory_results
  if count is less than 1:
    set state.order.id is input.values.id
    set state.order.sku is input.values.sku
    set state.order.quantity is input.values.quantity
    set state.order.status is "Rejected"
    create "Order" with state.order as order
    set state.alert.sku is input.values.sku
    set state.alert.message is "Unknown SKU."
    create "Alert" with state.alert as alert
    set state.error is "Cannot place order: unknown SKU."
    set state.status.message is state.error
    create "Status" with state.status as status
    return "rejected"
  let idx is count - 1
  let stock is list get inventory_results at idx
  if stock.quantity is less than input.values.quantity:
    set state.order.id is input.values.id
    set state.order.sku is input.values.sku
    set state.order.quantity is input.values.quantity
    set state.order.status is "Rejected"
    create "Order" with state.order as order
    set state.alert.sku is input.values.sku
    set state.alert.message is "Insufficient stock."
    create "Alert" with state.alert as alert
    set state.error is "Insufficient stock for the requested order."
    set state.status.message is state.error
    create "Status" with state.status as status
    return "rejected"
  set state.order.id is input.values.id
  set state.order.sku is input.values.sku
  set state.order.quantity is input.values.quantity
  set state.order.status is "Placed"
  create "Order" with state.order as order
  let remaining is stock.quantity - input.values.quantity
  update "Inventory" where sku is stock.sku set:
    quantity is remaining
  if remaining is less than 3:
    set state.alert.sku is stock.sku
    set state.alert.message is "Low stock alert."
    create "Alert" with state.alert as alert
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "placed"

flow "fulfill_order":
  find "Order" where id is input.values.id
  let count is list length of order_results
  if count is less than 1:
    set state.error is "Order not found."
    set state.status.message is state.error
    create "Status" with state.status as status
    return "missing"
  let idx is count - 1
  let current is list get order_results at idx
  update "Order" where id is current.id set:
    status is "Fulfilled"
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "fulfilled"

page "home":
  title is "Inventory & Orders"
  section "Quick actions":
    row:
      column:
        button "Seed Products":
          calls flow "seed_products"
      column:
        button "Reset":
          calls flow "reset_state"
  section "Products":
    row:
      column:
        card "Products":
          table is "Product"
      column:
        card "Inventory":
          table is "Inventory"
  section "Place order":
    card "Place order":
      form is "Order"
      button "Place order":
        calls flow "place_order"
      button "Fulfill order":
        calls flow "fulfill_order"
  section "Orders":
    card "Orders":
      table is "Order"
  section "Alerts":
    card "Alerts":
      table is "Alert"
  card "Status":
    table is "Status"
