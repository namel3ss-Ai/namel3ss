spec is "1.0"

record "Expense":
  fields:
    date is text must be present
    category is text must be present
    amount is number must be greater than 0
    note is text

record "CategoryTotal":
  field "category" is text must be present
  field "total" is number must be greater than 0

record "Status":
  field "message" is text must be present

flow "seed_expenses":
  set state.expense with:
    date is "2024-04-01"
    category is "Travel"
    amount is 120
    note is "Client visit"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-02"
    category is "Meals"
    amount is 24
    note is "Team lunch"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-03"
    category is "Supplies"
    amount is 65
    note is "Printer ink"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-04"
    category is "Utilities"
    amount is 98
    note is "Cloud hosting"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-05"
    category is "Travel"
    amount is 45
    note is "Taxi"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-06"
    category is "Meals"
    amount is 18
    note is "Coffee"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-07"
    category is "Supplies"
    amount is 32
    note is "Notebooks"
  create "Expense" with state.expense as expense
  set state.expense with:
    date is "2024-04-08"
    category is "Utilities"
    amount is 110
    note is "Monitoring"
  create "Expense" with state.expense as expense
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "seeded"

flow "create_expense":
  set state.expense with:
    date is input.values.date
    category is input.values.category
    amount is input.values.amount
    note is input.values.note
  create "Expense" with state.expense as expense
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "created"

flow "reset_state":
  set state.expense with:
    date is null
    category is null
    amount is null
    note is null
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "reset"

flow "recompute_totals":
  set state.error is null
  delete "CategoryTotal" where true
  let totals is map:
    "Travel" is 0
    "Meals" is 0
    "Supplies" is 0
    "Utilities" is 0
  find "Expense" where true
  for each result in expense_results:
    if result.category is "Travel":
      let current is map get totals key "Travel"
      set totals is map set totals key "Travel" value current + result.amount
    else:
      if result.category is "Meals":
        let current is map get totals key "Meals"
        set totals is map set totals key "Meals" value current + result.amount
      else:
        if result.category is "Supplies":
          let current is map get totals key "Supplies"
          set totals is map set totals key "Supplies" value current + result.amount
        else:
          if result.category is "Utilities":
            let current is map get totals key "Utilities"
            set totals is map set totals key "Utilities" value current + result.amount
  let keys is map keys totals
  for each key in keys:
    let total_value is map get totals key key
    if total_value is greater than 0:
      set state.category_total.category is key
      set state.category_total.total is total_value
      create "CategoryTotal" with state.category_total as category_total
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "ok"

page "home":
  title is "Expense Tracker"
  section "Quick actions":
    row:
      column:
        button "Seed Expenses":
          calls flow "seed_expenses"
      column:
        button "Reset":
          calls flow "reset_state"
      column:
        button "Recompute Totals":
          calls flow "recompute_totals"
  row:
    column:
      card "Add expense":
        form is "Expense"
        button "Save expense":
          calls flow "create_expense"
    column:
      card "Status":
        table is "Status"
  section "Expenses":
    card "Expenses":
      table is "Expense"
  section "Totals by category":
    card "Totals by category":
      table is "CategoryTotal"
