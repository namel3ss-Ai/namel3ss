spec is "1.0"

record "Expense":
  field "date" is text must be present
  field "category" is text must be present
  field "amount" is number must be greater than 0
  field "note" is text

record "CategoryTotal":
  field "category" is text must be present
  field "total" is number must be greater than 0

record "Status":
  field "message" is text must be present

flow "seed_expenses":
  set state.expense.date is "2024-04-01"
  set state.expense.category is "Travel"
  set state.expense.amount is 120
  set state.expense.note is "Client visit"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-02"
  set state.expense.category is "Meals"
  set state.expense.amount is 24
  set state.expense.note is "Team lunch"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-03"
  set state.expense.category is "Supplies"
  set state.expense.amount is 65
  set state.expense.note is "Printer ink"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-04"
  set state.expense.category is "Utilities"
  set state.expense.amount is 98
  set state.expense.note is "Cloud hosting"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-05"
  set state.expense.category is "Travel"
  set state.expense.amount is 45
  set state.expense.note is "Taxi"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-06"
  set state.expense.category is "Meals"
  set state.expense.amount is 18
  set state.expense.note is "Coffee"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-07"
  set state.expense.category is "Supplies"
  set state.expense.amount is 32
  set state.expense.note is "Notebooks"
  create "Expense" with state.expense as expense
  set state.expense.date is "2024-04-08"
  set state.expense.category is "Utilities"
  set state.expense.amount is 110
  set state.expense.note is "Monitoring"
  create "Expense" with state.expense as expense
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "seeded"

flow "create_expense":
  set state.expense.date is input.values.date
  set state.expense.category is input.values.category
  set state.expense.amount is input.values.amount
  set state.expense.note is input.values.note
  create "Expense" with state.expense as expense
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "created"

flow "reset_state":
  set state.expense.date is null
  set state.expense.category is null
  set state.expense.amount is null
  set state.expense.note is null
  set state.error is null
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "reset"

flow "recompute_totals":
  set state.error is null
  delete "CategoryTotal" where true
  let totals is map:
    "Travel" is 0
    "Meals" is 0
    "Supplies" is 0
    "Utilities" is 0
  find "Expense" where true
  for each result in expense_results:
    if result.category is "Travel":
      let current is map get totals key "Travel"
      set totals is map set totals key "Travel" value current + result.amount
    else:
      if result.category is "Meals":
        let current is map get totals key "Meals"
        set totals is map set totals key "Meals" value current + result.amount
      else:
        if result.category is "Supplies":
          let current is map get totals key "Supplies"
          set totals is map set totals key "Supplies" value current + result.amount
        else:
          if result.category is "Utilities":
            let current is map get totals key "Utilities"
            set totals is map set totals key "Utilities" value current + result.amount
  let keys is map keys totals
  for each key in keys:
    let total_value is map get totals key key
    if total_value is greater than 0:
      set state.category_total.category is key
      set state.category_total.total is total_value
      create "CategoryTotal" with state.category_total as category_total
  set state.status.message is "No errors ✅"
  create "Status" with state.status as status
  return "ok"

page "home":
  title is "Expense Tracker"
  section "Quick actions":
    row:
      column:
        button "Seed Expenses":
          calls flow "seed_expenses"
      column:
        button "Reset":
          calls flow "reset_state"
      column:
        button "Recompute Totals":
          calls flow "recompute_totals"
  row:
    column:
      card "Add expense":
        form is "Expense"
        button "Save expense":
          calls flow "create_expense"
    column:
      card "Status":
        table is "Status"
  section "Expenses":
    card "Expenses":
      table is "Expense"
  section "Totals by category":
    card "Totals by category":
      table is "CategoryTotal"
