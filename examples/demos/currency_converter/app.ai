spec is "1.0"

tool "fetch_rate":
  implemented using python

  input:
    from is text
    to is text

  output:
    pair is text
    rate is number
    source is text
    last_updated is text
    stale is boolean

record "ConversionRequest":
  field "from" is text must be present
  field "to" is text must be present
  field "amount" is number must be greater than 0

record "ConversionResult":
  fields:
    rate is number must be greater than 0
    converted is number must be greater than 0
    source is text must be present
    last_updated is text must be present
    stale is boolean must be present

record "RateCache":
  field "pair" is text must be present
  field "rate" is number must be greater than 0

record "Status":
  field "message" is text must be present

flow "seed_defaults":
  set state.request with:
    from is "EUR"
    to is "USD"
    amount is 50
  set state.error is null
  set state.status.message is "No errors ✅"
  delete "Status" where true
  create "Status" with state.status as status
  return "seeded"

flow "reset_state":
  set state.request with:
    from is null
    to is null
    amount is null
  set state.error is null
  set state.status.message is "No errors ✅"
  delete "Status" where true
  create "Status" with state.status as status
  return "reset"

flow "convert":
  let from_code is input.values.from
  if from_code is null:
    set from_code is "EUR"
  let to_code is input.values.to
  if to_code is null:
    set to_code is "USD"
  let amount is input.values.amount
  if amount is null:
    set amount is 1
  let result is fetch_rate:
    from is from_code
    to is to_code
  let rate is result.rate
  let source is result.source
  let last_updated is result.last_updated
  let stale is result.stale
  set state.rate_cache.pair is result.pair
  set state.rate_cache.rate is rate
  delete "RateCache" where pair is result.pair
  create "RateCache" with state.rate_cache as rate_cache
  let converted is amount * rate
  set state.conversion_result with:
    rate is rate
    converted is converted
    source is source
    last_updated is last_updated
    stale is stale
  create "ConversionResult" with state.conversion_result as conversion_result
  set state.error is null
  set state.status.message is "No errors ✅"
  delete "Status" where true
  create "Status" with state.status as status
  return converted

page "home":
  title is "Currency Converter"
  section "Quick actions":
    row:
      column:
        button "Seed Defaults":
          calls flow "seed_defaults"
      column:
        button "Reset":
          calls flow "reset_state"
      column:
        button "Convert":
          calls flow "convert"
  section "Convert":
    card "Convert":
      form is "ConversionRequest"
      button "Convert":
        calls flow "convert"
  section "Result":
    card "Conversion Result":
      table is "ConversionResult"
  section "Cached rates":
    card "Rate Cache":
      table is "RateCache"
  card "Status":
    table is "Status"
