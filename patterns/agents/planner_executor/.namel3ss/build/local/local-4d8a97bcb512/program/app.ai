spec is "1.0"

identity "User":
  field "email" is text must be present
  field "role" is text must be present

record "PlanStep":
  field "plan_id" is text must be present
  field "step_order" is number must be present
  field "description" is text must be present

ai "planner_ai":
  provider is "mock"
  model is "mock-model"
  system_prompt is "You propose short, deterministic plans."

agent "planner":
  ai is "planner_ai"
  system_prompt is "Draft a short plan with 3 steps."

flow "plan_request": requires identity.role is "planner"
  let goal is input.goal
  run agent "planner" with input: goal as proposal
  set state.plan_proposal is proposal
  set state.plan_id is "plan-001"
  let steps is list:
    map:
      "plan_id" is state.plan_id
      "step_order" is 1
      "description" is "Define scope"
    map:
      "plan_id" is state.plan_id
      "step_order" is 2
      "description" is "Draft tasks"
    map:
      "plan_id" is state.plan_id
      "step_order" is 3
      "description" is "Review deliverables"
  for each step in steps:
    set state.plan_step is step
    create "PlanStep" with state.plan_step as step
  return "plan_saved"

flow "execute_plan": requires identity.role is "planner"
  let plan_id is input.plan_id
  find "PlanStep" where plan_id is plan_id
  for each step in planstep_results:
    set state.last_step is step
  let count is list length of planstep_results
  set state.executed_steps is count
  return count

flow "plan_and_execute_demo": requires identity.role is "planner"
  set state.plan_id is "demo-plan"
  run agent "planner" with input: "Demo plan for onboarding." as proposal
  set state.plan_proposal is proposal
  let steps is list:
    map:
      "plan_id" is state.plan_id
      "step_order" is 1
      "description" is "Confirm requirements"
    map:
      "plan_id" is state.plan_id
      "step_order" is 2
      "description" is "Create checklist"
    map:
      "plan_id" is state.plan_id
      "step_order" is 3
      "description" is "Review completion"
  for each step in steps:
    set state.plan_step is step
    create "PlanStep" with state.plan_step as step
  find "PlanStep" where plan_id is state.plan_id
  for each step in planstep_results:
    set state.last_step is step
  let count is list length of planstep_results
  return count

page "home": requires identity.role is "planner"
  title is "Planner + Executor"
  text is "Planner proposes; executor runs deterministic steps."
  button "Run demo":
    calls flow "plan_and_execute_demo"
  table is "PlanStep"
