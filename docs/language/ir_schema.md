# IR Schema

> This document defines the canonical IR schema and field ordering. It is authoritative and must remain stable.

## Conventions
- All IR nodes inherit `Node` and therefore include `line` and `column` fields.
- Field order is the dataclass declaration order, with base fields first.
- A trailing `?` means the field is optional (its value may be `None`).
- The debug `type` key used in IR dumps is not part of the IR schema.

## Canonical IR Schema
<!-- CONTRACT:ir_schema -->
```json
{
  "aliases": {"Assignable": "VarReference | StatePath" },
  "nodes": {
    "AIDecl": ["line?", "column?", "name", "model", "provider", "system_prompt?", "exposed_tools", "memory"],
    "AIMemory": ["line?", "column?", "short_term", "semantic", "profile"],
    "AdvanceTime": ["line?", "column?", "amount"],
    "AgentDecl": ["line?", "column?", "name", "ai_name", "system_prompt?", "agent_id?", "role?"],
    "AgentMergePolicy": ["line?", "column?", "policy", "require_keys?", "require_non_empty?", "score_key?", "score_rule?", "min_consensus?", "consensus_key?"],
    "AgentTeam": ["line?", "column?", "team_id", "members"],
    "AgentTeamMember": ["line?", "column?", "name", "agent_id", "role?"],
    "AskAIStmt": ["line?", "column?", "ai_name", "input_expr", "target"],
    "AttrAccess": ["line?", "column?", "base", "attrs"],
    "BinaryOp": ["line?", "column?", "op", "left", "right"],
    "BuiltinCallExpr": ["line?", "column?", "name", "arguments"],
    "ButtonItem": ["line?", "column?", "visibility?", "label", "flow_name"],
    "CallArg": ["line?", "column?", "name", "value"],
    "CallFlowExpr": ["line?", "column?", "flow_name", "arguments", "outputs"],
    "CallFunctionExpr": ["line?", "column?", "function_name", "arguments"],
    "CallPipelineExpr": ["line?", "column?", "pipeline_name", "arguments", "outputs"],
    "CardAction": ["line?", "column?", "label", "flow_name?", "kind", "target?"],
    "CardGroupItem": ["line?", "column?", "visibility?", "children"],
    "CardItem": ["line?", "column?", "visibility?", "label?", "children", "stat?", "actions?"],
    "CardStat": ["line?", "column?", "value", "label?"],
    "ChartItem": ["line?", "column?", "visibility?", "record_name?", "source?", "chart_type?", "x?", "y?", "explain?"],
    "ChatCitationsItem": ["line?", "column?", "visibility?", "source"],
    "ChatComposerItem": ["line?", "column?", "visibility?", "flow_name"],
    "ChatItem": ["line?", "column?", "visibility?", "children"],
    "ChatMemoryItem": ["line?", "column?", "visibility?", "source", "lane?"],
    "ChatMessagesItem": ["line?", "column?", "visibility?", "source"],
    "ChatThinkingItem": ["line?", "column?", "visibility?", "when"],
    "ColumnItem": ["line?", "column?", "visibility?", "children"],
    "Comparison": ["line?", "column?", "kind", "left", "right"],
    "ComposeItem": ["line?", "column?", "visibility?", "name", "children"],
    "ContractDecl": ["line?", "column?", "kind", "name", "signature"],
    "Create": ["line?", "column?", "record_name", "values", "target"],
    "Delete": ["line?", "column?", "record_name", "predicate"],
    "DividerItem": ["line?", "column?", "visibility?"],
    "DrawerItem": ["line?", "column?", "visibility?", "label", "children"],
    "EnqueueJob": ["line?", "column?", "job_name", "input_expr?", "schedule_kind?", "schedule_expr?"],
    "Expression": ["line?", "column?"],
    "Find": ["line?", "column?", "record_name", "predicate"],
    "Flow": ["line?", "column?", "name", "body", "requires?", "audited", "purity", "steps?", "declarative"],
    "FlowCallForeign": ["line?", "column?", "foreign_name", "arguments"],
    "FlowCreate": ["line?", "column?", "record_name", "fields"],
    "FlowDelete": ["line?", "column?", "record_name", "selector?"],
    "FlowField": ["line?", "column?", "name", "value"],
    "FlowInput": ["line?", "column?", "fields"],
    "FlowInputField": ["line?", "column?", "name", "type_name", "type_was_alias", "raw_type_name?", "type_line?", "type_column?"],
    "FlowRequire": ["line?", "column?", "condition"],
    "FlowStep": ["line?", "column?"],
    "FlowUpdate": ["line?", "column?", "record_name", "selector?", "updates"],
    "ForEach": ["line?", "column?", "name", "iterable", "body"],
    "FormFieldConfig": ["line?", "column?", "name", "help?", "readonly?"],
    "FormFieldRef": ["line?", "column?", "name"],
    "FormGroup": ["line?", "column?", "label", "fields"],
    "FormItem": ["line?", "column?", "visibility?", "record_name", "groups?", "fields?"],
    "FunctionCallArg": ["line?", "column?", "name", "value"],
    "FunctionDecl": ["line?", "column?", "name", "signature", "body"],
    "FunctionParam": ["line?", "column?", "name", "type_name", "required"],
    "FunctionSignature": ["line?", "column?", "inputs", "outputs?"],
    "If": ["line?", "column?", "condition", "then_body", "else_body"],
    "ImageItem": ["line?", "column?", "visibility?", "src", "alt", "role?"],
    "JobDecl": ["line?", "column?", "name", "body", "when?"],
    "Let": ["line?", "column?", "name", "expression", "constant"],
    "LinkItem": ["line?", "column?", "visibility?", "label", "page_name"],
    "ListAction": ["line?", "column?", "label", "flow_name?", "kind", "target?"],
    "ListExpr": ["line?", "column?", "items"],
    "ListFilterExpr": ["line?", "column?", "target", "var_name", "predicate"],
    "ListItem": ["line?", "column?", "visibility?", "record_name", "variant", "item", "empty_text?", "selection?", "actions?"],
    "ListItemMapping": ["line?", "column?", "primary", "secondary?", "meta?", "icon?"],
    "ListMapExpr": ["line?", "column?", "target", "var_name", "body"],
    "ListOpExpr": ["line?", "column?", "kind", "target", "value?", "index?"],
    "ListReduceExpr": ["line?", "column?", "target", "acc_name", "item_name", "start", "body"],
    "Literal": ["line?", "column?", "value"],
    "LogStmt": ["line?", "column?", "level", "message", "fields?"],
    "MapEntry": ["line?", "column?", "key", "value"],
    "MapExpr": ["line?", "column?", "entries"],
    "MapOpExpr": ["line?", "column?", "kind", "target", "key?", "value?"],
    "Match": ["line?", "column?", "expression", "cases", "otherwise?"],
    "MatchCase": ["line?", "column?", "pattern", "body"],
    "MetricStmt": ["line?", "column?", "kind", "name", "operation", "value?", "labels?"],
    "ModalItem": ["line?", "column?", "visibility?", "label", "children"],
    "Node": ["line?", "column?"],
    "NumberEntry": ["line?", "column?", "kind", "value?", "record_name?", "label?"],
    "NumberItem": ["line?", "column?", "visibility?", "entries"],
    "OrchestrationBlock": ["line?", "column?", "branches", "merge", "target"],
    "OrchestrationBranch": ["line?", "column?", "name", "call_expr"],
    "OrchestrationMergePolicy": ["line?", "column?", "policy", "precedence?"],
    "Page": ["line?", "column?", "name", "items", "requires?", "purpose?", "state_defaults?"],
    "PageItem": ["line?", "column?", "visibility?"],
    "ParallelAgentEntry": ["line?", "column?", "agent_name", "input_expr"],
    "ParallelBlock": ["line?", "column?", "tasks", "merge?"],
    "ParallelMergePolicy": ["line?", "column?", "policy"],
    "ParallelTask": ["line?", "column?", "name", "body"],
    "PolicyDecl": ["line?", "column?", "rules"],
    "PolicyRule": ["line?", "column?", "action", "mode", "permissions"],
    "Program": ["line?", "column?", "spec_version", "theme", "theme_tokens", "theme_runtime_supported", "theme_preference", "ui_settings", "capabilities", "records", "functions", "flow_contracts", "flows", "jobs", "pages", "ais", "tools", "agents", "policy?", "agent_team?", "identity?", "state_defaults?"],
    "Repeat": ["line?", "column?", "count", "body"],
    "RepeatWhile": ["line?", "column?", "condition", "limit", "body", "limit_line?", "limit_column?"],
    "Return": ["line?", "column?", "expression"],
    "RowItem": ["line?", "column?", "visibility?", "children"],
    "RunAgentStmt": ["line?", "column?", "agent_name", "input_expr", "target"],
    "RunAgentsParallelStmt": ["line?", "column?", "entries", "target", "merge?"],
    "Save": ["line?", "column?", "record_name"],
    "SectionItem": ["line?", "column?", "visibility?", "label?", "children"],
    "Set": ["line?", "column?", "target", "expression"],
    "StatePath": ["line?", "column?", "path"],
    "Statement": ["line?", "column?"],
    "StoryItem": ["line?", "column?", "visibility?", "title", "steps"],
    "StoryStep": ["line?", "column?", "title", "text?", "icon?", "image?", "image_role?", "tone?", "requires?", "next?"],
    "TabItem": ["line?", "column?", "label", "children", "visibility?"],
    "TableColumnDirective": ["line?", "column?", "kind", "name", "label?"],
    "TableItem": ["line?", "column?", "visibility?", "record_name", "columns?", "empty_text?", "sort?", "pagination?", "selection?", "row_actions?"],
    "TablePagination": ["line?", "column?", "page_size"],
    "TableRowAction": ["line?", "column?", "label", "flow_name?", "kind", "target?"],
    "TableSort": ["line?", "column?", "by", "order"],
    "TabsItem": ["line?", "column?", "visibility?", "tabs", "default"],
    "TextItem": ["line?", "column?", "visibility?", "value"],
    "ThemeChange": ["line?", "column?", "value"],
    "TitleItem": ["line?", "column?", "visibility?", "value"],
    "ToolCallArg": ["line?", "column?", "name", "value"],
    "ToolCallExpr": ["line?", "column?", "tool_name", "arguments"],
    "ToolDecl": ["line?", "column?", "name", "kind", "input_fields", "output_fields", "capabilities", "purity", "timeout_seconds?", "declared_as"],
    "ToolField": ["line?", "column?", "name", "type_name", "required"],
    "TryCatch": ["line?", "column?", "try_body", "catch_var", "catch_body"],
    "UnaryOp": ["line?", "column?", "op", "operand"],
    "Update": ["line?", "column?", "record_name", "predicate", "updates"],
    "UpdateField": ["line?", "column?", "name", "expression"],
    "UploadItem": ["line?", "column?", "visibility?", "name", "accept", "multiple"],
    "VarReference": ["line?", "column?", "name"],
    "ViewItem": ["line?", "column?", "visibility?", "record_name"]
  }
}
```
<!-- END_CONTRACT:ir_schema -->
