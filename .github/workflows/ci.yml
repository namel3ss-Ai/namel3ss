name: CI

on:
  push:
  pull_request:

jobs:
  release-gate:
    name: release-gate
    runs-on: ubuntu-latest
    env:
      PYTHONDONTWRITEBYTECODE: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Compile check
        run: python -m compileall src -q -x '.*namel3ss/runtime/build.*'

      - name: Executable spec suite
        run: python -m pytest -q tests/spec

      - name: Invariant catalog + legacy syntax scan
        run: python -m pytest -q tests/invariants/test_invariant_catalog.py tests/invariants/test_legacy_syntax_scan.py

      - name: Trace schema v1
        run: python -m pytest -q tests/traces/test_trace_schema_v1.py

      - name: Run tests
        run: python -m pytest -q

      - name: Release smoke (build + start)
        run: python -m pytest -q tests/runtime/test_production_server.py

      - name: Ensure CI artifacts dir
        run: mkdir -p .namel3ss/ci_artifacts

      - name: Expression surface gate
        run: n3 expr-check --json .namel3ss/ci_artifacts/expr_report.json

      - name: Release check
        run: n3 release-check --json .namel3ss/ci_artifacts/release_report.json --txt .namel3ss/ci_artifacts/release_report.txt --fast

      - name: Benchmark report
        run: python tools/bench.py --out .namel3ss/ci_artifacts/bench_report.json --iterations 1 --timing deterministic

      - name: Dump release-check context (always)
        if: ${{ always() }}
        run: |
          echo "=== COMMIT ==="
          git rev-parse HEAD || true
          echo "=== release_report.txt ==="
          (test -f .namel3ss/ci_artifacts/release_report.txt && cat .namel3ss/ci_artifacts/release_report.txt) || echo "missing release_report.txt"
          echo "=== release_report.json ==="
          (test -f .namel3ss/ci_artifacts/release_report.json && cat .namel3ss/ci_artifacts/release_report.json) || echo "missing release_report.json"

      - name: Upload release gate reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-reports
          path: .namel3ss/ci_artifacts/

      - name: DX verify gate
        run: n3 verify --dx --json

      - name: Patterns suite
        run: |
          runnable_patterns=$(find patterns -mindepth 1 -maxdepth 2 -type f -name "app.ai" -printf '%h\n' | sort -u)
          echo "Runnable pattern dirs:"
          echo "${runnable_patterns}"
          for pattern in ${runnable_patterns}; do
            echo "Pattern ${pattern}"
            (cd "${pattern}" && n3 test)
            (cd "${pattern}" && n3 verify --prod)
          done

      - name: Clean pattern artifacts
        run: python tools/clean_pattern_artifacts.py

      - name: Enforce line limit
        run: python tools/line_limit_check.py

      - name: Enforce single responsibility
        run: python tools/responsibility_check.py

      - name: Docker build guard
        run: python tools/docker_build_guard.py

      - name: Report largest source files
        run: python tools/top_files.py

      - name: Repo clean check
        run: python -m namel3ss.beta_lock.repo_clean

  docker-build:
    name: docker-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker version
        run: docker --version

      - name: Build image
        run: docker build -t namel3ss:ci .

  cli-install-gate:
    name: cli-install-gate
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare CI artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: mkdir -p .namel3ss/ci

      - name: Prepare CI artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path .namel3ss/ci | Out-Null

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            poetry.lock
            uv.lock
            requirements*.txt

      - name: Install package (editable)
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: CLI install gate (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .namel3ss/ci
          test -d .namel3ss/ci
          python -m compileall src -q
          python tools/line_limit_check.py
          python -m pip install -e .
          python -m namel3ss --help > .namel3ss/ci/namel3ss_help.txt
          mkdir -p .namel3ss/ci
          : > .namel3ss/ci/pytest_cli_install_gate.log
          if python -m pytest -q tests/test_cli_install.py > .namel3ss/ci/pytest_cli_install_gate.log 2>&1; then
            :
          else
            if test -f .namel3ss/ci/pytest_cli_install_gate.log; then
              cat .namel3ss/ci/pytest_cli_install_gate.log
            else
              echo "missing pytest_cli_install_gate.log"
            fi
            exit 1
          fi
          mkdir -p .namel3ss/ci
          : > .namel3ss/ci/pytest_cli_install_gate.log
          if python -m pytest -q > .namel3ss/ci/pytest_cli_install_gate.log 2>&1; then
            :
          else
            if test -f .namel3ss/ci/pytest_cli_install_gate.log; then
              cat .namel3ss/ci/pytest_cli_install_gate.log
            else
              echo "missing pytest_cli_install_gate.log"
            fi
            exit 1
          fi

      - name: CLI install gate (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path .namel3ss/ci | Out-Null
          if (-not (Test-Path -Path .namel3ss/ci -PathType Container)) {
            throw "missing .namel3ss/ci"
          }
          python -m compileall src -q
          if ($LASTEXITCODE -ne 0) {
            exit $LASTEXITCODE
          }
          python tools/line_limit_check.py
          if ($LASTEXITCODE -ne 0) {
            exit $LASTEXITCODE
          }
          python -m pip install -e .
          if ($LASTEXITCODE -ne 0) {
            exit $LASTEXITCODE
          }
          python -m namel3ss --help | Out-File -FilePath .namel3ss/ci/namel3ss_help.txt -Encoding utf8
          if ($LASTEXITCODE -ne 0) {
            exit $LASTEXITCODE
          }
          $pytestOutput = & python -m pytest -q tests/test_cli_install.py 2>&1
          if ($LASTEXITCODE -ne 0) {
            New-Item -ItemType Directory -Force -Path .namel3ss/ci | Out-Null
            $pytestOutput | Out-File -FilePath .namel3ss/ci/pytest_cli_install_gate.log -Encoding utf8
            if (Test-Path -Path .namel3ss/ci/pytest_cli_install_gate.log) {
              Get-Content -Path .namel3ss/ci/pytest_cli_install_gate.log
            } else {
              $pytestOutput | Write-Output
              Write-Output "missing pytest_cli_install_gate.log"
            }
            exit $LASTEXITCODE
          }
          $pytestOutput = & python -m pytest -q 2>&1
          if ($LASTEXITCODE -ne 0) {
            New-Item -ItemType Directory -Force -Path .namel3ss/ci | Out-Null
            $pytestOutput | Out-File -FilePath .namel3ss/ci/pytest_cli_install_gate.log -Encoding utf8
            if (Test-Path -Path .namel3ss/ci/pytest_cli_install_gate.log) {
              Get-Content -Path .namel3ss/ci/pytest_cli_install_gate.log
            } else {
              $pytestOutput | Write-Output
              Write-Output "missing pytest_cli_install_gate.log"
            }
            exit $LASTEXITCODE
          }

      - name: Upload CLI gate artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cli-install-gate-${{ matrix.os }}
          path: .namel3ss/ci/
